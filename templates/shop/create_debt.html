{% extends 'base.html' %}

{% block title %}Borc Yarat - Siqaret Mağazası{% endblock %}

{% block content %}
<div class="px-4 py-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">Yeni Borc Yarat</h2>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column - Customer Info and Barcode -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Müştəri Məlumatları</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mağaza *</label>
                        <select id="shop-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" required>
                            <option value="">-- Mağaza seçin --</option>
                            {% for shop in shops %}
                                <option value="{{ shop.id }}">{{ shop.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Müştəri Adı *</label>
                        <input type="text" id="customer-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefon</label>
                        <input type="text" id="customer-phone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="+994">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Son Tarix *</label>
                        <input type="date" id="due-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Qeyd</label>
                        <textarea id="debt-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="Əlavə qeydlər..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Barcode Scanner -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Məhsul Əlavə Et</h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Barkod Oxut</label>
                    <input type="text" id="barcode-input" 
                           class="w-full px-3 py-3 text-lg border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                           placeholder="Barkod oxudun..." disabled>
                </div>

                <!-- Search by Name -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Və ya adı ilə axtar</label>
                    <div class="flex space-x-2">
                        <input type="text" id="search-input" 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                               placeholder="Məhsul adı..." disabled>
                        <button id="search-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200" disabled>
                            Axtar
                        </button>
                    </div>
                </div>

                <!-- Search Results -->
                <div id="search-results" class="hidden mt-4 border border-gray-200 rounded-md max-h-60 overflow-y-auto">
                    <div id="search-results-list" class="divide-y divide-gray-200"></div>
                </div>
            </div>
        </div>

        <!-- Middle Column - Scanned Items -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-6 sticky top-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Seçilmiş Məhsullar</h3>

                <div id="items-list" class="space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 text-center py-8">Heç bir məhsul əlavə edilməyib</p>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-200">
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-600">Məhsul Sayı:</span>
                        <span id="total-items" class="font-semibold">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Ümumi Məbləğ:</span>
                        <span id="total-price" class="text-xl font-bold text-gray-800">0.00 AZN</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Actions -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-6 sticky top-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Əməliyyatlar</h3>

                <div class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-semibold text-blue-800 mb-2">Borc Məlumatları</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Müştəri:</span>
                                <span id="display-customer-name" class="font-semibold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Mağaza:</span>
                                <span id="display-shop-name" class="font-semibold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Son Tarix:</span>
                                <span id="display-due-date" class="font-semibold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Məhsul Sayı:</span>
                                <span id="display-item-count" class="font-semibold">0</span>
                            </div>
                        </div>
                    </div>

                    <button id="create-debt-btn" 
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed"
                            disabled>
                        Borc Yarat
                    </button>

                    <button id="clear-all-btn" 
                            class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg transition duration-200">
                        Hamısını Təmizlə
                    </button>

                    <a href="/debts/" 
                       class="block text-center bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                        Borc Siyahısına Keç
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Messages -->
<div id="error-message" class="hidden fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded shadow-lg max-w-md z-50"></div>
<div id="success-message" class="hidden fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded shadow-lg max-w-md z-50"></div>

<script>
let scannedItems = [];
let currentShopId = null;

// DOM Elements
const shopSelect = document.getElementById('shop-select');
const customerName = document.getElementById('customer-name');
const customerPhone = document.getElementById('customer-phone');
const dueDate = document.getElementById('due-date');
const debtDescription = document.getElementById('debt-description');
const barcodeInput = document.getElementById('barcode-input');
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');
const searchResults = document.getElementById('search-results');
const searchResultsList = document.getElementById('search-results-list');
const itemsList = document.getElementById('items-list');
const totalItems = document.getElementById('total-items');
const totalPrice = document.getElementById('total-price');
const createDebtBtn = document.getElementById('create-debt-btn');
const clearAllBtn = document.getElementById('clear-all-btn');
const displayCustomerName = document.getElementById('display-customer-name');
const displayShopName = document.getElementById('display-shop-name');
const displayDueDate = document.getElementById('display-due-date');
const displayItemCount = document.getElementById('display-item-count');

// Set minimum date to today
dueDate.min = new Date().toISOString().split('T')[0];

// Shop selection
shopSelect.addEventListener('change', (e) => {
    currentShopId = e.target.value;
    const isEnabled = !!currentShopId;
    
    barcodeInput.disabled = !isEnabled;
    searchInput.disabled = !isEnabled;
    searchBtn.disabled = !isEnabled;
    
    if (isEnabled) {
        barcodeInput.focus();
        displayShopName.textContent = shopSelect.options[shopSelect.selectedIndex].text;
    } else {
        displayShopName.textContent = '-';
    }
    updateCreateButton();
});

// Customer info updates
customerName.addEventListener('input', () => {
    displayCustomerName.textContent = customerName.value || '-';
    updateCreateButton();
});

dueDate.addEventListener('change', () => {
    displayDueDate.textContent = dueDate.value || '-';
    updateCreateButton();
});

// Barcode functionality
barcodeInput.addEventListener('keypress', async (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        await processBarcode(barcodeInput.value.trim());
    }
});

// Search functionality
searchBtn.addEventListener('click', searchByName);
searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        searchByName();
    }
});

async function processBarcode(barcode) {
    if (!barcode || !currentShopId) return;

    try {
        const response = await fetch('/api/scan/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                barcode: barcode,
                shop_id: currentShopId
            })
        });

        const data = await response.json();

        if (response.ok) {
            addItem(data);
            barcodeInput.value = '';
            hideError();
        } else {
            showError(data.error);
        }
    } catch (error) {
        showError('Şəbəkə xətası');
    }
}

async function searchByName() {
    const searchTerm = searchInput.value.trim();

    if (!currentShopId || !searchTerm) return;

    try {
        const response = await fetch(`/api/search/?q=${encodeURIComponent(searchTerm)}&shop_id=${currentShopId}`);
        const data = await response.json();

        if (response.ok) {
            displaySearchResults(data.results || []);
        } else {
            showError(data.error);
        }
    } catch (error) {
        showError('Şəbəkə xətası');
    }
}

function displaySearchResults(results) {
    if (results.length === 0) {
        searchResultsList.innerHTML = '<p class="text-gray-500 text-center py-4">Heç bir məhsul tapılmadı</p>';
    } else {
        searchResultsList.innerHTML = results.map(good => `
            <div class="p-3 hover:bg-gray-50 cursor-pointer" onclick="addSearchedItem(${JSON.stringify(good).replace(/"/g, '&quot;')})">
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="font-semibold text-gray-800">${good.name}</h4>
                        <p class="text-sm text-gray-600">${good.category} • ${good.price} AZN</p>
                    </div>
                    <span class="text-sm text-gray-500">Stok: ${good.stock_count}</span>
                </div>
            </div>
        `).join('');
    }
    searchResults.classList.remove('hidden');
}

function addSearchedItem(good) {
    addItem(good);
    hideSearchResults();
    searchInput.value = '';
}

function hideSearchResults() {
    searchResults.classList.add('hidden');
}

// Item management
function addItem(good) {
    const existingItem = scannedItems.find(item => item.id === good.id);

    if (existingItem) {
        existingItem.quantity++;
    } else {
        scannedItems.push({
            ...good,
            quantity: 1
        });
    }

    renderItems();
    updateTotals();
    updateCreateButton();
}

function removeItem(index) {
    scannedItems.splice(index, 1);
    renderItems();
    updateTotals();
    updateCreateButton();
}

function updateQuantity(index, change) {
    const newQuantity = scannedItems[index].quantity + change;
    
    if (newQuantity <= 0) {
        removeItem(index);
    } else {
        scannedItems[index].quantity = newQuantity;
        renderItems();
        updateTotals();
    }
}

function renderItems() {
    if (scannedItems.length === 0) {
        itemsList.innerHTML = '<p class="text-gray-500 text-center py-8">Heç bir məhsul əlavə edilməyib</p>';
        return;
    }

    itemsList.innerHTML = scannedItems.map((item, index) => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
            <div class="flex-1">
                <h4 class="font-semibold text-gray-800">${item.name}</h4>
                <p class="text-sm text-gray-600">${item.price} AZN • Stok: ${item.stock_count}</p>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="updateQuantity(${index}, -1)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 w-6 h-6 rounded text-sm">-</button>
                <span class="font-semibold w-8 text-center">${item.quantity}</span>
                <button onclick="updateQuantity(${index}, 1)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 w-6 h-6 rounded text-sm">+</button>
                <span class="font-bold text-gray-800 w-16 text-right">${(item.price * item.quantity).toFixed(2)}</span>
                <button onclick="removeItem(${index})" class="bg-red-500 hover:bg-red-600 text-white w-6 h-6 rounded text-sm">×</button>
            </div>
        </div>
    `).join('');
}

function updateTotals() {
    const itemCount = scannedItems.reduce((sum, item) => sum + item.quantity, 0);
    const total = scannedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

    totalItems.textContent = itemCount;
    totalPrice.textContent = `${total.toFixed(2)} AZN`;
    displayItemCount.textContent = itemCount;
}

function updateCreateButton() {
    const canCreate = scannedItems.length > 0 && 
                     currentShopId && 
                     customerName.value.trim() && 
                     dueDate.value;
    
    createDebtBtn.disabled = !canCreate;
}

// Create debt
createDebtBtn.addEventListener('click', async () => {
    if (scannedItems.length === 0) return;

    try {
        const response = await fetch('/api/debt/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                customer_name: customerName.value.trim(),
                customer_phone: customerPhone.value.trim(),
                shop_id: currentShopId,
                items: scannedItems,
                due_date: dueDate.value,
                description: debtDescription.value.trim()
            })
        });

        const data = await response.json();

        if (response.ok) {
            showSuccess('Borc uğurla yaradıldı! Stok yeniləndi.');
            clearForm();
        } else {
            showError(data.error);
        }
    } catch (error) {
        showError('Xəta baş verdi. Yenidən cəhd edin.');
    }
});

// Clear all
clearAllBtn.addEventListener('click', clearForm);

function clearForm() {
    scannedItems = [];
    customerName.value = '';
    customerPhone.value = '';
    dueDate.value = '';
    debtDescription.value = '';
    barcodeInput.value = '';
    searchInput.value = '';
    
    renderItems();
    updateTotals();
    updateCreateButton();
    
    displayCustomerName.textContent = '-';
    displayDueDate.textContent = '-';
    displayItemCount.textContent = '0';
    hideSearchResults();
}

// Utility functions
function showError(message) {
    const errorDiv = document.getElementById('error-message');
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
    setTimeout(() => errorDiv.classList.add('hidden'), 5000);
}

function showSuccess(message) {
    const successDiv = document.getElementById('success-message');
    successDiv.textContent = message;
    successDiv.classList.remove('hidden');
    setTimeout(() => successDiv.classList.add('hidden'), 5000);
}

function hideError() {
    document.getElementById('error-message').classList.add('hidden');
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Close search results when clicking outside
document.addEventListener('click', (e) => {
    if (!searchResults.contains(e.target) && e.target !== searchInput && e.target !== searchBtn) {
        hideSearchResults();
    }
});
</script>
{% endblock %}