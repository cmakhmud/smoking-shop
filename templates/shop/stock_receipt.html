{% extends 'base.html' %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Başlıq -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Stok Qəbulu</h1>
                    <p class="mt-2 text-lg text-gray-600">Barkod oxudaraq bir neçə məhsulun stokunu əlavə edin</p>
                </div>
                <div class="flex items-center space-x-3">
                    {% if is_admin %}
                    <div class="bg-blue-100 text-blue-800 px-3 py-2 rounded-lg">
                        <span class="text-sm font-medium">Admin Rejimi</span>
                    </div>
                    {% else %}
                    <div class="bg-green-100 text-green-800 px-3 py-2 rounded-lg">
                        <span class="text-sm font-medium">Mağaza:</span>
                        <span class="font-semibold">{{ worker_shop.name }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Sol Sütun - Skan Formu -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-green-600 to-green-700 px-6 py-4">
                        <h2 class="text-xl font-semibold text-white flex items-center">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Məhsul Əlavə Et
                        </h2>
                    </div>
                    <div class="p-6">
                        {% if messages %}
                            {% for message in messages %}
                                <div class="mb-6 p-4 rounded-lg {% if message.tags == 'success' %}bg-green-50 border border-green-200 text-green-700{% else %}bg-red-50 border border-red-200 text-red-700{% endif %}">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 mr-3 {% if message.tags == 'success' %}text-green-500{% else %}text-red-500{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            {% if message.tags == 'success' %}
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            {% else %}
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            {% endif %}
                                        </svg>
                                        {{ message }}
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}

                        <!-- Mağaza Seçimi (Admin üçün) -->
                        {% if is_admin %}
                        <div class="mb-6">
                            <label for="shop_id" class="block text-sm font-medium text-gray-700 mb-2">Mağaza</label>
                            <select id="shop_id" name="shop_id" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                <option value="">Mağaza seçin</option>
                                {% for shop in shops %}
                                    <option value="{{ shop.id }}">{{ shop.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <!-- Axtarış Funksionallığı -->
                        <div class="mb-4">
                            <label for="search-product" class="block text-sm font-medium text-gray-700 mb-2">
                                Məhsul axtar
                            </label>
                            <div class="flex space-x-3">
                                <input 
                                    type="text" 
                                    id="search-product" 
                                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                    placeholder="Məhsul adı və ya barkodu..."
                                >
                                <button 
                                    type="button" 
                                    id="search-btn"
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors duration-200"
                                >
                                    Axtar
                                </button>
                            </div>
                            <div id="search-results" class="mt-2 hidden max-h-48 overflow-y-auto border border-gray-200 rounded-lg"></div>
                        </div>

                        <!-- Tədarükçü Məlumatları -->
                        <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="supplier" class="block text-sm font-medium text-gray-700 mb-2">Tədarükçü</label>
                                <input 
                                    type="text" 
                                    id="supplier" 
                                    name="supplier"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                    placeholder="Tədarükçü adı..."
                                >
                            </div>
                            <div>
                                <label for="receipt_type" class="block text-sm font-medium text-gray-700 mb-2">Qəbul Növü</label>
                                <select id="receipt_type" name="receipt_type" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    <option value="purchase">Satın Alma</option>
                                    <option value="transfer">Transfer</option>
                                    <option value="adjustment">Stok Düzəltmə</option>
                                </select>
                            </div>
                        </div>

                        <!-- Barkod Skaneri -->
                        <div class="mb-6">
                            <label for="barcode" class="block text-sm font-medium text-gray-700 mb-2">
                                Məhsul Barkodu
                                <span class="text-xs text-gray-500 ml-1">(Enter düyməsi ilə əlavə et)</span>
                            </label>
                            <div class="flex space-x-3">
                                <input 
                                    type="text" 
                                    id="barcode" 
                                    name="barcode" 
                                    required 
                                    autofocus
                                    class="flex-1 px-4 py-4 text-lg border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                    placeholder="Barkodu oxudun və ya yazın..."
                                >
                                <button 
                                    type="button" 
                                    id="add-item-btn"
                                    class="bg-green-500 hover:bg-green-600 text-white px-6 py-4 rounded-xl font-semibold transition-colors duration-200"
                                >
                                    Əlavə Et
                                </button>
                            </div>
                            <p id="barcode-hint" class="mt-1 text-sm text-gray-500 hidden">
                                Bu barkod bazada tapılmadı. <a href="#" id="create-product-link" class="text-blue-600 hover:underline">Yeni məhsul yarat</a>
                            </p>
                        </div>

                        <!-- Yeni Məhsul Formu (Gizli) -->
                        <div id="new-product-form" class="mb-6 p-4 border border-blue-300 bg-blue-50 rounded-lg hidden">
                            <h3 class="font-semibold text-blue-800 mb-3">Yeni Məhsul Yarat</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Məhsul Adı *</label>
                                    <input type="text" id="new-product-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Barkod</label>
                                    <input type="text" id="new-product-barcode" class="w-full px-3 py-2 border border-gray-300 rounded-lg" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Satış Qiyməti *</label>
                                    <input type="number" step="0.01" id="new-product-price" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Alış Qiyməti *</label>
                                    <input type="number" step="0.01" id="new-product-cost" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Kateqoriya</label>
                                    <select id="new-product-category" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="">Kateqoriya seçin</option>
                                        {% for category in categories %}
                                            <option value="{{ category.id }}">{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end space-x-3">
                                <button type="button" id="cancel-create-btn" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Ləğv et
                                </button>
                                <button type="button" id="save-product-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Məhsulu Yadda Saxla
                                </button>
                            </div>
                        </div>

                        <!-- Skan Edilmiş Məhsullar Siyahısı -->
                        <div id="items-list" class="mb-6 space-y-3 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-4">
                            <p class="text-gray-500 text-center py-4">Hələ ki, heç bir məhsul əlavə edilməyib</p>
                        </div>

                        <!-- Xülasə -->
                        <div class="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Ümumi Məhsul:</span>
                                    <span id="total-items" class="font-semibold ml-2">0</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Ümumi Miqdar:</span>
                                    <span id="total-quantity" class="font-semibold ml-2">0</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Ümumi Dəyər:</span>
                                    <span id="total-cost" class="font-semibold ml-2 text-green-600">0.00 AZN</span>
                                </div>
                            </div>
                        </div>

                        <!-- Qeydlər -->
                        <div class="mb-6">
                            <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">Qeydlər</label>
                            <textarea 
                                id="notes" 
                                name="notes" 
                                rows="2"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                placeholder="Əlavə qeydlər..."
                            ></textarea>
                        </div>

                        <!-- Göndər Düyməsi -->
                        <form method="post" id="stockReceiptForm">
                            {% csrf_token %}
                            <input type="hidden" id="items-data" name="items_data">
                            <input type="hidden" id="form-shop-id" name="shop_id">
                            <input type="hidden" id="form-notes" name="notes">
                            <input type="hidden" id="form-supplier" name="supplier">
                            <input type="hidden" id="form-receipt-type" name="receipt_type">
                            
                            <button 
                                type="submit" 
                                id="submit-btn"
                                disabled
                                class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl disabled:bg-gray-400 disabled:cursor-not-allowed"
                            >
                                <div class="flex items-center justify-center space-x-3">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <span class="text-lg">Bütün Stokları Əlavə Et</span>
                                </div>
                            </button>
                        </form>

                       
                    </div>
                </div>
            </div>

            <!-- Sağ Sütun - Son Qəbullar -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden sticky top-8">
                    <div class="bg-gradient-to-r from-gray-600 to-gray-700 px-6 py-4">
                        <h2 class="text-xl font-semibold text-white flex items-center">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            Son Qəbullar
                        </h2>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4 max-h-96 overflow-y-auto">
                            {% for receipt in recent_receipts %}
                                <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 hover:bg-gray-100 transition-colors duration-200">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h3 class="font-semibold text-gray-900 text-sm">{{ receipt.good.name }}</h3>
                                            <p class="text-xs text-gray-500 mt-1">{{ receipt.quantity }} ədəd • {{ receipt.unit_cost }} AZN</p>
                                            <p class="text-xs text-gray-500">{{ receipt.supplier }}</p>
                                            <p class="text-xs text-gray-400 mt-1">{{ receipt.created_at|timesince }} əvvəl</p>
                                        </div>
                                        <div class="text-right">
                                            <div class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">
                                                +{{ receipt.quantity }}
                                            </div>
                                            <div class="text-xs text-gray-600 mt-1">
                                                {{ receipt.total_cost }} AZN
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                <div class="text-center py-8">
                                    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                    </svg>
                                    <p class="text-gray-500 text-sm">Hələ ki, stok qəbulu yoxdur.</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
let scannedItems = [];
let currentShopId = null;
let currentBarcode = '';

// Elementləri seç
const barcodeInput = document.getElementById('barcode');
const addItemBtn = document.getElementById('add-item-btn');
const itemsList = document.getElementById('items-list');
const submitBtn = document.getElementById('submit-btn');
const itemsData = document.getElementById('items-data');
const formShopId = document.getElementById('form-shop-id');
const formNotes = document.getElementById('form-notes');
const formSupplier = document.getElementById('form-supplier');
const formReceiptType = document.getElementById('form-receipt-type');
const notesInput = document.getElementById('notes');
const supplierInput = document.getElementById('supplier');
const receiptTypeSelect = document.getElementById('receipt_type');
const shopSelect = document.getElementById('shop_id');
const totalItems = document.getElementById('total-items');
const totalQuantity = document.getElementById('total-quantity');
const totalCost = document.getElementById('total-cost');
const searchInput = document.getElementById('search-product');
const searchBtn = document.getElementById('search-btn');
const searchResults = document.getElementById('search-results');
const barcodeHint = document.getElementById('barcode-hint');
const createProductLink = document.getElementById('create-product-link');
const newProductForm = document.getElementById('new-product-form');
const cancelCreateBtn = document.getElementById('cancel-create-btn');
const saveProductBtn = document.getElementById('save-product-btn');
const newProductName = document.getElementById('new-product-name');
const newProductBarcode = document.getElementById('new-product-barcode');
const newProductPrice = document.getElementById('new-product-price');
const newProductCost = document.getElementById('new-product-cost');
const newProductCategory = document.getElementById('new-product-category');
const testSubmitBtn = document.getElementById('test-submit-btn');

// Admin üçün mağaza seçimi
if (shopSelect) {
    shopSelect.addEventListener('change', (e) => {
        currentShopId = e.target.value;
        formShopId.value = currentShopId;
        console.log('Shop selected:', currentShopId);
    });
} else {
    // İşçilər üçün onların mağazası
    currentShopId = '{{ worker_shop.id }}';
    formShopId.value = currentShopId;
    console.log('Worker shop ID:', currentShopId);
}

// Form məlumatlarını yenilə
supplierInput.addEventListener('input', () => {
    formSupplier.value = supplierInput.value;
    console.log('Supplier updated:', supplierInput.value);
});

receiptTypeSelect.addEventListener('change', () => {
    formReceiptType.value = receiptTypeSelect.value;
    console.log('Receipt type updated:', receiptTypeSelect.value);
});

notesInput.addEventListener('input', () => {
    formNotes.value = notesInput.value;
});

// Test göndərmə düyməsi
if (testSubmitBtn) {
    testSubmitBtn.addEventListener('click', testManualSubmission);
}

function testManualSubmission() {
    console.log('=== TEST SUBMISSION ===');
    
    if (!currentShopId) {
        alert('Zəhmət olmasa mağaza seçin');
        return;
    }
    
    // Test məlumatları yarat
    const testItems = [{
        id: 1, // Test üçün məhsul ID-si
        name: "Test Məhsul",
        barcode: "TEST123",
        quantity: 5,
        unit_cost: 10.50
    }];
    
    // Form məlumatlarını təyin et
    const jsonString = JSON.stringify(testItems);
    console.log('Test JSON:', jsonString);
    
    itemsData.value = jsonString;
    formShopId.value = currentShopId;
    formNotes.value = 'Test qeyd';
    formSupplier.value = 'Test Tədarükçü';
    formReceiptType.value = 'purchase';
    
    // Formu göndər
    console.log('Submitting form...');
    document.getElementById('stockReceiptForm').submit();
}

// Düyməyə kliklədikdə məhsul əlavə et
addItemBtn.addEventListener('click', addItemByBarcode);

// Enter düyməsi ilə məhsul əlavə et
barcodeInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addItemByBarcode();
    }
});

// Axtarış funksionallığı
searchBtn.addEventListener('click', searchProducts);
searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        searchProducts();
    }
});

// Yeni məhsul yaratma linki
createProductLink.addEventListener('click', (e) => {
    e.preventDefault();
    showNewProductForm();
});

// Yeni məhsul formunu ləğv et
cancelCreateBtn.addEventListener('click', () => {
    hideNewProductForm();
    barcodeHint.classList.add('hidden');
    barcodeInput.value = '';
    barcodeInput.focus();
});

// Yeni məhsulu yadda saxla
saveProductBtn.addEventListener('click', saveNewProduct);

async function addItemByBarcode() {
    const barcode = barcodeInput.value.trim();
    
    if (!barcode) {
        alert('Zəhmət olmasa barkod daxil edin');
        return;
    }

    if (!currentShopId) {
        alert('Zəhmət olmasa mağaza seçin');
        return;
    }

    currentBarcode = barcode;
    console.log('Scanning barcode:', barcode, 'for shop:', currentShopId);

    try {
        const response = await fetch('/api/scan-stock/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                barcode: barcode,
                shop_id: currentShopId
            })
        });

        const data = await response.json();
        console.log('Scan response:', data);

        if (response.ok) {
            addItemToList(data);
            barcodeInput.value = '';
            barcodeHint.classList.add('hidden');
            barcodeInput.focus();
        } else {
            // Məhsul tapılmadı - yeni məhsul yaratma təklifi göstər
            barcodeHint.classList.remove('hidden');
            newProductBarcode.value = barcode;
        }
    } catch (error) {
        console.error('Scan error:', error);
        alert('Xəta baş verdi: ' + error);
    }
}

async function searchProducts() {
    const query = searchInput.value.trim();
    
    if (!query) {
        alert('Zəhmət olmasa axtarış sözü daxil edin');
        return;
    }

    if (!currentShopId) {
        alert('Zəhmət olmasa mağaza seçin');
        return;
    }

    try {
        const response = await fetch(`/api/search-stock/?q=${encodeURIComponent(query)}&shop_id=${currentShopId}`);
        const data = await response.json();

        if (response.ok) {
            displaySearchResults(data.results);
        } else {
            alert(data.error || 'Axtarış xətası');
        }
    } catch (error) {
        alert('Xəta baş verdi: ' + error);
    }
}

function displaySearchResults(results) {
    if (results.length === 0) {
        searchResults.innerHTML = '<p class="text-gray-500 text-center py-4">Heç bir məhsul tapılmadı</p>';
        searchResults.classList.remove('hidden');
        return;
    }

    searchResults.innerHTML = results.map(good => `
        <div class="p-3 border-b border-gray-200 hover:bg-gray-50 cursor-pointer" onclick="addSearchedItem(${JSON.stringify(good).replace(/"/g, '&quot;')})">
            <div class="font-semibold text-gray-800">${good.name}</div>
            <div class="text-sm text-gray-600">Barkod: ${good.barcode} • Stok: ${good.stock_count}</div>
            <div class="text-sm text-gray-500">Qiymət: ${good.price} AZN</div>
        </div>
    `).join('');
    
    searchResults.classList.remove('hidden');
}

function addSearchedItem(good) {
    addItemToList(good);
    searchInput.value = '';
    searchResults.classList.add('hidden');
    searchResults.innerHTML = '';
}

function showNewProductForm() {
    barcodeHint.classList.add('hidden');
    newProductForm.classList.remove('hidden');
    newProductName.focus();
}

function hideNewProductForm() {
    newProductForm.classList.add('hidden');
    newProductName.value = '';
    newProductPrice.value = '';
    newProductCost.value = '';
    newProductCategory.value = '';
}

async function saveNewProduct() {
    const name = newProductName.value.trim();
    const price = parseFloat(newProductPrice.value);
    const cost = parseFloat(newProductCost.value);
    
    if (!name) {
        alert('Zəhmət olmasa məhsul adını daxil edin');
        return;
    }
    
    if (!price || price <= 0) {
        alert('Zəhmət olmasa düzgün satış qiyməti daxil edin');
        return;
    }
    
    if (!cost || cost <= 0) {
        alert('Zəhmət olmasa düzgün alış qiyməti daxil edin');
        return;
    }

    try {
        const response = await fetch('/api/create-good/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                name: name,
                barcode: currentBarcode,
                price: price,
                buy_price: cost,
                category_id: newProductCategory.value || null,
                shop_id: currentShopId
            })
        });

        const data = await response.json();

        if (response.ok) {
            // Yeni məhsulu siyahıya əlavə et
            addItemToList(data.good);
            
            // Formu təmizlə və gizlət
            hideNewProductForm();
            barcodeInput.value = '';
            barcodeInput.focus();
            
            // Müvəffəqiyyət mesajı
            showMessage('Məhsul uğurla yaradıldı və siyahıya əlavə edildi', 'success');
        } else {
            alert(data.error || 'Məhsul yaratma xətası');
        }
    } catch (error) {
        alert('Xəta baş verdi: ' + error);
    }
}

function addItemToList(good) {
    console.log('Adding item to list:', good);
    
    // Məlumatları təmizlə
    const cleanGood = {
        id: parseInt(good.id) || 0,
        name: String(good.name || ''),
        barcode: String(good.barcode || ''),
        stock_count: parseInt(good.stock_count) || 0,
        buy_price: parseFloat(good.buy_price) || 0,
        price: parseFloat(good.price) || 0
    };
    
    const existingItemIndex = scannedItems.findIndex(item => item.id === cleanGood.id);
    
    if (existingItemIndex !== -1) {
        // Mövcud məhsulun miqdarını artır
        scannedItems[existingItemIndex].quantity += 1;
        scannedItems[existingItemIndex].total_cost = scannedItems[existingItemIndex].quantity * scannedItems[existingItemIndex].unit_cost;
    } else {
        // Yeni məhsul əlavə et
        scannedItems.push({
            id: cleanGood.id,
            name: cleanGood.name,
            barcode: cleanGood.barcode,
            quantity: 1,
            current_stock: cleanGood.stock_count,
            unit_cost: cleanGood.buy_price || cleanGood.price || 0,
            total_cost: cleanGood.buy_price || cleanGood.price || 0
        });
    }
    
    console.log('Scanned items after add:', scannedItems);
    renderItemsList();
    updateSubmitButton();
    updateSummary();
}

function removeItem(index) {
    scannedItems.splice(index, 1);
    renderItemsList();
    updateSubmitButton();
    updateSummary();
}

function updateQuantity(index, newQuantity) {
    newQuantity = parseInt(newQuantity);
    if (newQuantity <= 0) {
        removeItem(index);
    } else {
        scannedItems[index].quantity = newQuantity;
        scannedItems[index].total_cost = scannedItems[index].quantity * scannedItems[index].unit_cost;
        renderItemsList();
        updateSubmitButton();
        updateSummary();
    }
}

function updateUnitCost(index, newUnitCost) {
    scannedItems[index].unit_cost = parseFloat(newUnitCost) || 0;
    scannedItems[index].total_cost = scannedItems[index].quantity * scannedItems[index].unit_cost;
    renderItemsList();
    updateSubmitButton();
    updateSummary();
}

function renderItemsList() {
    if (scannedItems.length === 0) {
        itemsList.innerHTML = '<p class="text-gray-500 text-center py-4">Hələ ki, heç bir məhsul əlavə edilməyib</p>';
        return;
    }

    itemsList.innerHTML = scannedItems.map((item, index) => `
        <div class="bg-gray-50 rounded-lg border border-gray-200 p-3">
            <div class="flex items-start justify-between mb-2">
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-800 text-sm">${item.name}</h4>
                    <p class="text-xs text-gray-600">Barkod: ${item.barcode} • Cari stok: ${item.current_stock}</p>
                </div>
                <button onclick="removeItem(${index})" class="bg-red-500 hover:bg-red-600 text-white font-bold px-2 py-1 rounded text-xs">Sil</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
                <div>
                    <label class="block text-xs text-gray-600 mb-1">Miqdar</label>
                    <div class="flex items-center space-x-1">
                        <button onclick="updateQuantity(${index}, ${item.quantity - 1})" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold w-6 h-6 rounded text-xs">-</button>
                        <input 
                            type="number" 
                            value="${item.quantity}" 
                            min="1"
                            onchange="updateQuantity(${index}, this.value)"
                            class="w-12 text-center border border-gray-300 rounded text-xs py-1"
                        >
                        <button onclick="updateQuantity(${index}, ${item.quantity + 1})" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold w-6 h-6 rounded text-xs">+</button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs text-gray-600 mb-1">Vahid Qiymət (AZN)</label>
                    <input 
                        type="number" 
                        value="${item.unit_cost.toFixed(2)}" 
                        step="0.01"
                        min="0"
                        onchange="updateUnitCost(${index}, this.value)"
                        class="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                        placeholder="0.00"
                    >
                </div>
                
                <div>
                    <label class="block text-xs text-gray-600 mb-1">Ümumi Qiymət</label>
                    <div class="font-semibold text-green-600 text-xs py-1">
                        ${item.total_cost.toFixed(2)} AZN
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function updateSummary() {
    const totalItemsCount = scannedItems.length;
    const totalQuantityCount = scannedItems.reduce((sum, item) => sum + item.quantity, 0);
    const totalCostValue = scannedItems.reduce((sum, item) => sum + item.total_cost, 0);
    
    totalItems.textContent = totalItemsCount;
    totalQuantity.textContent = totalQuantityCount;
    totalCost.textContent = totalCostValue.toFixed(2) + ' AZN';
}

function updateSubmitButton() {
    console.log('updateSubmitButton called, scannedItems:', scannedItems);
    
    if (scannedItems.length > 0) {
        submitBtn.disabled = false;
        
        // Sadə və təmiz JSON obyekti yaradın
        const itemsForSubmission = scannedItems.map(item => {
            // Hər bir sahəni təmizləyin
            return {
                id: parseInt(item.id) || 0,
                name: String(item.name || ''),
                barcode: String(item.barcode || ''),
                quantity: parseInt(item.quantity) || 1,
                unit_cost: parseFloat(item.unit_cost) || 0
            };
        });
        
        try {
            const jsonString = JSON.stringify(itemsForSubmission);
            console.log('JSON to submit:', jsonString);
            
            // JSON-u test edin
            JSON.parse(jsonString);
            itemsData.value = jsonString;
            
        } catch (error) {
            console.error('JSON error in updateSubmitButton:', error);
            console.error('Problematic items:', itemsForSubmission);
            submitBtn.disabled = true;
            itemsData.value = '';
            alert('JSON məlumatları düzgün deyil. Zəhmət olmasa məhsulları yenidən əlavə edin.');
        }
    } else {
        submitBtn.disabled = true;
        itemsData.value = '';
    }
}

// Form submit event listener
document.getElementById('stockReceiptForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    console.log('Form submission started...');
    
    if (scannedItems.length === 0) {
        alert('Zəhmət olmasa ən azı bir məhsul əlavə edin');
        return;
    }
    
    if (!currentShopId) {
        alert('Zəhmət olmasa mağaza seçin');
        return;
    }
    
    // Əvvəlcə JSON-u hazırlayın və yoxlayın
    try {
        const itemsForSubmission = scannedItems.map(item => ({
            id: parseInt(item.id) || 0,
            name: String(item.name || ''),
            barcode: String(item.barcode || ''),
            quantity: parseInt(item.quantity) || 1,
            unit_cost: parseFloat(item.unit_cost) || 0
        }));
        
        const jsonString = JSON.stringify(itemsForSubmission);
        console.log('Final JSON to submit:', jsonString);
        
        // JSON test
        JSON.parse(jsonString);
        
        // Form məlumatlarını təyin edin
        formShopId.value = currentShopId;
        formNotes.value = notesInput.value;
        formSupplier.value = supplierInput.value;
        formReceiptType.value = receiptTypeSelect.value;
        itemsData.value = jsonString;
        
        console.log('Form data prepared, submitting...');
        console.log('Shop ID:', currentShopId);
        console.log('Supplier:', supplierInput.value);
        console.log('Receipt type:', receiptTypeSelect.value);
        console.log('Items count:', itemsForSubmission.length);
        
        // Formu göndərin
        this.submit();
        
    } catch (error) {
        console.error('Form submission error:', error);
        console.error('Current scannedItems:', scannedItems);
        alert('Form məlumatları düzgün deyil. Xəta: ' + error.message);
    }
});

function showMessage(message, type = 'success') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-100 border-green-300 text-green-800' : 'bg-red-100 border-red-300 text-red-800'
    }`;
    alertDiv.innerHTML = `
        <div class="flex items-center">
            <svg class="w-5 h-5 mr-3 ${type === 'success' ? 'text-green-500' : 'text-red-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${type === 'success' ? 
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>' :
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'
                }
            </svg>
            ${message}
        </div>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Axtarış nəticələrini bağla
document.addEventListener('click', (e) => {
    if (!searchResults.contains(e.target) && e.target !== searchInput && e.target !== searchBtn) {
        searchResults.classList.add('hidden');
    }
});

// Barkod sahəsinə fokus
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, current shop:', currentShopId);
    console.log('Categories available:', {{ categories|length|default:0 }});
    barcodeInput.focus();
});
</script>
{% endblock %}